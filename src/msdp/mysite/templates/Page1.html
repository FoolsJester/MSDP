<!DOCTYPE html>
<html lang="en">
    
<!-- Google API Key = AIzaSyBS6Ca0PFx3eydXjgD17aQogUFe8jeOfqg -->
<!-- AccuWeather API Key = em8jLMl8jkAqrLiuJM0BCBQEoxHfJAJq -->
{% load static %}

<link rel="stylesheet" type="text/css" href="{% static 'Page1.css' %}" />


    <head>
        
        <!-- Use utf-8 encoding -->
        <meta charset="utf-8">
        
        <!-- Tell Internet Explorer or Edge use the latest rendering engine -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        
        <!-- Set the page width to the size of the device, set zoom to 1 -->
        <meta name="viewport" content="width = device-width, initial-scale = 1">
           
        <title> Page 1 </title>
           
        <!-- Bootstrap CDN for CSS, found on getbootstrap.com -->
        <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
        
        <!-- Bootstrap CDN for JQuery, found on getbootstrap.com  -->    
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
            
    </head>
    
    <body class="bg-secondary">
        
        
        <!-- Navigation Bar -->
        
        <nav class="navbar navbar-expand-sm bg-dark navbar-dark fixed-top">
            
            <div class="container">
            
               <a href="http://localhost:8000/dublinbus/" class="navbar-brand"> <strong>Team DPSM</strong> </a> 
                
                <button class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
                    
                </button>
                
                <div class="collapse navbar-collapse" id="navbarCollapse">
                
                    <ul class=navbar-nav ml-auto>
                    
                        <li id="plemx-root" class="nav-item">
                         
                            
                            <a href="http://www.theweathernetwork.com">The Weather Network</a>
                            <script type="text/javascript"> 

                              var _plm = _plm || [];
                              _plm.push(['_btn', 82501]); 
                              _plm.push(['_loc','eixx0014']);
                              _plm.push(['location', document.location.host ]);
                               (function(d,e,i) {
                              if (d.getElementById(i)) return;
                              var px = d.createElement(e);
                              px.type = 'text/javascript';
                              px.async = true;
                              px.id = i;
                              px.src = ('https:' == d.location.protocol ? 'https:' : 'http:') + '//widget.twnmm.com/js/btn/pelm.js?orig=en_ca';
                              var s = d.getElementsByTagName('script')[0];

                              var py = d.createElement('link');
                              py.rel = 'stylesheet'
                              py.href = ('https:' == d.location.protocol ? 'https:' : 'http:') + '//widget.twnmm.com/styles/btn/styles.css'

                              s.parentNode.insertBefore(px, s);
                              s.parentNode.insertBefore(py, s);
                            })(document, 'script', 'plmxbtn');
                            
                            </script>

                        
                        </li>
                    
                    
                    
                    </ul>
                
                </div>
            </div>
            
        </nav>
        
        
        
        <!-- Container -->
        <div id="containsAll" class="mt-5 pt-5">
            
            
            <!-- Row to keep map and input on the same line -->
            <div class="row" col-xl-3 col-lg-3 col-md-6 col-sm-12 col-xs-12>
               
                
                <!-- Found online, have used it before for WebApp Assignment2 -->
                <!--The div element for the map -->
                <div id="map"></div>

                    <script>
                    var globalJson = {}; //global variable used to store the lat and longs of each route according to route id
                    
                    // Initialize and add the map, will not be responsible for handling the directions directly.
                    function initMap() {
                        // The location of Dublin
                        var Dublin = {lat: 53.3351, lng: -6.2493};
                        // The map, centered at Dublin
                        var map = new google.maps.Map(
                            document.getElementById('map'), {zoom: 10, center: Dublin});
                    }


                    function calculateAndDisplayRoute(directionsService, directionsDisplay, line_id){
                        /*Function used to calculate and display relevant routes to users
                        
                        3 inputs are direction service, display and the line id. Direction service and display are part of the maps API
                        Line id is used to access the global json object in order to retrieve the relevant lats and longs of the route
                        */
                        var stops = globalJson[line_id]; //retrieve lat and longs
                        var count = stops[0]; //count used to get  destination
                        var start = "lat: "+stops[1][0]+", lng: "+stops[1][1];
                        var dest = "lat: "+stops[count][0]+", lng: "+stops[count][1];
                        //for loop to extract waypoints
                        var waypts = []; //empty array for all waypoints in trip i.e. stops between origin and dest
                        
                        for (var i = 2; i < count; i++) {
                            //must add waypoints in specific format as shwon below
                            waypts.push({
                              location: {lat: stops[i][0], lng: stops[i][1]},
                              stopover: true

                            });
                        }
                        
                        //part of API which determines route. Origin and dest self explanitory. Have optimise set to false as want waypoints visited in order
                        directionsService.route({
                          origin: {lat: stops[1][0], lng: stops[1][1]},
                          destination: {lat: stops[count][0], lng: stops[count][1]},
                          waypoints: waypts,
                          optimizeWaypoints: false,
                          travelMode: 'DRIVING'

                        },
                    
                        function(response, status) {
                          if (status === 'OK') {
                            directionsDisplay.setDirections(response);
                            var route = response.routes[0];
                          } 
                          else {
                            window.alert('Directions request failed due to ' + status);
                          }
                        });
                        
                        //need to provide new map in order for directions to be rendered. Usually done in init_Map function but must be here as is called by button
                        var Dublin = {lat: 53.3351, lng: -6.2493};
                        directionsDisplay.setMap(new google.maps.Map(
                            document.getElementById('map'), {zoom: 10, center: Dublin}));
                    }
                </script>
                    <!--Load the API from the specified URL
                    * The async attribute allows the browser to render the page while the API loads
                    * The key parameter will contain your own API key (which is not needed for this tutorial)
                    * The callback parameter executes the initMap() function
                    -->
                    <script async defer
                        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBS6Ca0PFx3eydXjgD17aQogUFe8jeOfqg&callback=initMap">
                    </script>
                    
                    <!-- Jumbotron to hold the form -->
                    <div class="jumbotron bg-primary border border-white pt-1 pb-1">
                    
                     <!-- The FORM -->
                     <form class="bg-infoml-5">
                                
                        <!-- Start -->
                        <div class="form-group p-2">
                            <label for="start" class="text-white blockquote">Start:</label>
                            <input id="start" type="text" class="float-none text-dark form-control" placeholder="Start Bus Stop ID">
                        </div>
                                
                        <!-- Destination -->
                        <div class="form-group p-2">
                            <label for="destination" class="text-white blockquote" >Destination:</label>
                            <input id="destination" type = "text" class="float-none text-dark form-control" placeholder="Destination Bus Stop ID">
                        </div>
                               
                        <!-- Date -->
                        <div class="form-group p-2">
                            <label for="date" class="text-white blockquote">Date:</label>
                            <span style="display:inline-block; width:2rem;"></span>
                            <input type="date" id = "date"  class="float-none text-dark form-control">
                        </div> 
                           
                           
                        <!-- Time -->
                        <div class="form-group p-2 mb-5"> 
                            <label for="time" class="text-white blockquote">Time:</label>
                            <span style="display:inline-block; width:3rem;"></span>
                            <input type ="time" id="time" class="float-none text-dark form-control">
                        </div>
                            
                        
                                
                        <!-- Submit -->
                        <div class="form-group p-2">
                            <span style="display:inline-block; width:3rem;"></span>
                            <button id="submit" value="Submit" class="text-dark btn btn-active btn btn-light">Submit</button>
                            <!-- <button id="submit" value="Submit" class="text-light btn btn-active">Submit</button> -->                     
                        </div>
                    
                           
                    </form>
                    </div>
                    
                    <!-- Jumbotron to hold Search Results and Details -->
                    <div class="jumbotron bg-primary pt-1 pb-1 border border-white">
                    
                        <div id='routes'>Result area</div>
                                
                    </div>  
                </div>
                
            
                <!-- Footer for the application -->
                <footer id="main-footer" class=" mb-0 bg-dark text-white fixed-bottom">
                    
                    <div class="container">
                    
                        <div class="row text-center">
                        
                            <div class="col-md-6 ml-auto">
                            
                            <p class="lead">
                            
                                Copyright &copy; <span id="year"></span>
                                
                            </p>
                            
                            
                            </div>
                        
                        </div>
                    
                    </div>
            
                </footer>
            
    
            </div>
        
        
        
        
        
                
   <!-- End of Body, Script area -->         
    
    <!-- Script Variables need to change or script will not work, class needs to change (maybe id or name?) @Dan Zhu -->
        <script>
        $(function(){
            $(".bg-infoml-5").submit(function(evt){
                evt.preventDefault();
                sub();
            });
        });
            
        /*Function responsible for taking the inputs on the page and providing them to the ann.py script. 

        This in turn gives the expected travel time as well as the stops needed to get from origin to dest. Lat and long are also returned from ann.py */ 
        function sub()
            {
                var start=$("#start").val();
                var end=$("#destination").val();
                var date=$("#date").val();
                var time=$("#time").val();
                var timenumber=time.split(":");
                var seconds=Number(timenumber[0])*60*60 + Number(timenumber[1])*60;
                data_to_backend = {'Start':start,'End':end,'Time':seconds,'Date':date}; 

                $.post("/dublinbus/form_input/", data_to_backend, function(data){
                    data=JSON.parse(data);
                    str=showRoutes(data);
                    document.getElementById('routes').innerHTML = str;
                })
                .fail(function() {
                    alert( "Connection fail, please refresh the website." );
                });
                
            }
            
        function showRoutes(json){
                /*
                Function is in charge of presenting the results returned by ann.py as well as providing button for showing route on map
                
                ANN.py returns an estimated travel time as well as the the stops between origin and destination. This function presents the travel time to the user and 
                also fills the globalJSON object with the lats and longs of all the stops for each route available. As ANN.py does not calculate for all routes yet, only those with
                an estimated travle time are provided to the user. The button generated for the route also only shows for the routes with an estimated time.
                
                Reason for plotting all stops is because a bus route may not take the most straightforward route, therefore if origin and destination are the only waypoints then the given route will look very different to the actual route
                */
                var str='';
                var findRoute=false;
                for (var i in json) { //for each of the routes returned by ann.py
                    if (json[i]['locations']!= []){ //must ensure there are locations in order for them to be plotted
                        var id = json[i]['line']; //route id
                        var waypnts = []; //empty array for storing the lats and longs, will late be added to globalJSON object
                        var data =  json[i]['locations'];
                        var count = 0;
                        for (item in data){ // need a count because google directions only accepts 15 waypoints
                        }
                        if(count > 15){
                            //if over 15 points on map need to divide and skip stops, not ideal but more accurate than just origin/ dest
                            var interval = Math.ceil((count-2)/13);
                            var newcount = 0
                            waypnts.push(data[0]); //first point
                            for (x=interval-1; x<count; x+=interval){
                                waypnts.push(data[x]);
                                newcount ++;

                            }
                            waypnts.unshift(newcount); // count needs to be first for another function, unshift puts first in array
                            waypnts.push(data[count-1]); //last stop naturally last in array

                        }
                        else{
                            // if count not over 15 then just chuck 'em in the way they are
                            waypnts.push(count);
                            for (item in data){
                                waypnts.push(data[item]);
                            }  
                        }
                        var jsonObj = { 
                            // add route id and list of stops to globalJSON obj in format below
                            ['id'+id] : waypnts
                        };
                        globalJson['id'+id]=waypnts;

                    }
                    
                    //If there is no travel time it means ann.py couldn't calculate one, these options will not be shown to user. 
                    if (parseInt(json[i]['traveltime'])>0){ //display div with results and provide button to display route on map. Button also calls function
                        var id = "id"+json[i]['line'];
                        str+="<div  class='route-div' id='route-div' style='border:#FFFFFF 1px ridge; margin-bottom:-14%; padding:0;'>"+
                        "<div class='route-div-detail' data-value = "+json[i]['line']+ "><img src='/static/icon/bus.png'>"+json[i]['line']+'</div>'+
                        'Next Bus: '+converToHour(parseInt(json[i]['pairarrtime'][0]))+'<br>'+'Time to Dest: '+Math.round(json[i]['traveltime']/60)+' min'+'</div><br><input type = "button" value=Show onclick="calculateAndDisplayRoute(new google.maps.DirectionsService, new google.maps.DirectionsRenderer, \'' + id + '\')"/>';
                        findRoute=true;
                    }

                }
                if (!findRoute)
                    str='No bus route!!'

                return str;
                }
            
        function converToHour(a){
                var hours=parseInt(a/3600);
                var mins=parseInt((a-hours*3600)/60);
                var time='';
                if (hours<10)
                    hours='0'+hours;
                if (mins<10)
                    time=hours+':0'+mins;
                else
                    time=hours+':'+mins;
                return time;
        }
            
        $(function(){    
            $("#route-div-detail").bind("click",function(){
                alert("Yes");
            });
        });

        </script>
        
        <!-- Bootstrap CDN for Javascript, found on getbootstrap.com -->
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous">
        </script>  
                 
        
        <!-- Get current year -->
        
        <script>
        
        $('#year').text(new Date().getFullYear());
        
        </script>
        
    </body>
</html>
               
            
            
        
    
    
